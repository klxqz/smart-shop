function Product(e,t){this.form=$(e),this.add2cart=this.form.find(".add2cart"),this.button=this.add2cart.find("#button-cart");for(var i in t)this[i]=t[i];var r=this;this.form.find(".services input[type=checkbox]").click(function(){var e=$('select[name="service_variant['+$(this).val()+']"]');e.length&&($(this).is(":checked")?e.removeAttr("disabled"):e.attr("disabled","disabled")),r.updatePrice()}),this.form.find(".services .service-variants").on("change",function(){r.updatePrice()}),this.form.find(".skus input[type=radio]").click(function(){$(this).data("image-id")&&$("#product-image-"+$(this).data("image-id")).click(),$(this).data("disabled")?r.button.attr("disabled","disabled"):r.button.removeAttr("disabled");var e=$(this).val();r.updateSkuServices(e),r.updatePrice()});var a=this.form.find(".skus input[type=radio]:checked:not(:disabled)");a.length||(a=this.form.find(".skus input[type=radio]:not(:disabled):first").prop("checked",!0).click()),a.click(),this.form.find(".inline-select a").click(function(){var e=$(this).closest(".inline-select");return e.find("a.selected").removeClass("selected"),$(this).addClass("selected"),e.find(".sku-feature").val($(this).data("value")).change(),!1}),this.form.find(".sku-feature").change(function(){var e="";r.form.find(".sku-feature").each(function(){e+=$(this).data("feature-id")+":"+$(this).val()+";"});var t=r.features[e];t?(t.image_id&&$("#product-image-"+t.image_id).click(),r.updateSkuServices(t.id),t.available?r.button.removeAttr("disabled"):(r.form.find("div.stocks div").hide(),r.form.find(".sku-no-stock").show(),r.button.attr("disabled","disabled")),r.add2cart.find("price-new").data("price",t.price),r.updatePrice(t.price,t.compare_price)):(r.form.find("div.stocks div").hide(),r.form.find(".sku-no-stock").show(),r.button.attr("disabled","disabled"),r.add2cart.find(".price-old").hide(),r.add2cart.find(".price-new").empty())}),this.form.find(".sku-feature:first").change(),this.form.find(".skus input:radio:checked").length||this.form.find(".skus input:radio:enabled:first").attr("checked","checked"),this.form.submit(function(){var e=$(this),t=$('<div class="button-overlay"><i class="icon16 loading"></i></div>');return $(this).find("#button-cart").append(t),$.post(e.attr("action")+"?html=1",e.serialize(),function(i){if("ok"==i.status){var r=$("#cart-total"),a=e;t.remove();var s=$('<div class="product-info"></div>').append(e.clone()),n=s.find(".ajax_product_info");showMsg('<i class="fa fa-check-circle"></i> Товар <a href="'+n.data("url")+'">'+n.data("name")+'</a> успешно добавлен в <a href="'+cart_url+'">корзину</a>'),$("#cart").addClass("open"),a.closest(".dialog").length?s.insertAfter(a.closest(".dialog")):s.appendTo("body"),s.css({top:a.offset().top,left:a.offset().left,width:a.width()+"px",height:a.height()+"px",position:"absolute",overflow:"hidden"}).animate({top:r.offset().top,left:r.offset().left,width:0,height:0,opacity:.5},500,function(){s.remove(),r.html(i.data.total);var e=$("#cart .cart-items tr[data-id="+i.data.item_id+"]"),t=parseInt(a.find("#input-quantity").val());if(e.length)t=parseInt(e.find(".quantity").text())+t,e.find(".quantity").text(t);else{var c={url:n.data("url"),name:n.data("name"),img:n.data("img"),price:n.data("price"),quantity:t,id:i.data.item_id};$("#cart_item_tmpl").tmpl(c).appendTo("#cart .cart-items table tbody"),$("#cart .cart-items").show(),$("#cart .cart-buttons").show(),$("#cart .cart-empty").hide()}$("table.cart").length&&location.reload()}),a.closest(".dialog").length&&a.closest(".dialog").trigger("close"),i.data.error&&alert(i.data.error)}else"fail"==i.status&&alert(i.errors)},"json"),!1}),this.form.find(".compare-add").click(function(){var e=$.cookie("shop_compare");e=e?e.split(","):[];var t=r.form.find(".ajax_product_info"),i=$.inArray($(this).data("id")+"",e);if(-1==i){e.push($(this).data("id"));var a=compare_url.replace(/compare\/.*$/,"compare/"+e.join(",")+"/");showMsg('<i class="fa fa-check-circle"></i> Товар <a href="'+t.data("url")+'">'+t.data("name")+'</a> успешно добавлен в <a href="'+a+'">Список сравнения</a>')}else{e.splice(i,1);var a=compare_url.replace(/compare\/.*$/,"compare/"+e.join(",")+"/");showMsg('<i class="fa fa-check-circle"></i> Товар <a href="'+t.data("url")+'">'+t.data("name")+'</a> удален из <a href="'+a+'">Списка сравнения</a>',"warning")}return $(".compare-total").attr("href",a),$(".compare-total .count").text(e.length),e.length>0?$.cookie("shop_compare",e.join(","),{expires:30,path:"/"}):$.cookie("shop_compare",null,{expires:30,path:"/"}),!1}),this.form.find(".wishlist-add").click(function(){var e=$.cookie("shop_wishlist");e=e?e.split(","):[];var t=$.inArray($(this).data("id")+"",e),i=r.form.find(".ajax_product_info");return-1==t?(e.push($(this).data("id")),showMsg('<i class="fa fa-check-circle"></i> Товар <a href="'+i.data("url")+'">'+i.data("name")+'</a> успешно добавлен в <a href="'+wishlist_url+'">Избранное</a>')):(e.splice(t,1),showMsg('<i class="fa fa-check-circle"></i> Товар <a href="'+i.data("url")+'">'+i.data("name")+'</a> удален из <a href="'+wishlist_url+'">Избранного</a>',"warning")),$(".wishlist-total .count").text(e.length),e.length>0?$.cookie("shop_wishlist",e.join(","),{expires:30,path:"/"}):$.cookie("shop_wishlist",null,{expires:30,path:"/"}),!1})}Product.prototype.currencyFormat=function(e,t){var i,r,a,s,n,c=this.currency.frac_digits,d=this.currency.decimal_point,o=this.currency.thousands_sep;isNaN(c=Math.abs(c))&&(c=2),void 0==d&&(d=","),void 0==o&&(o="."),i=parseInt(e=(+e||0).toFixed(c))+"",(r=i.length)>3?r%=3:r=0,n=r?i.substr(0,r)+o:"",a=i.substr(r).replace(/(\d{3})(?=\d)/g,"$1"+o),s=c&&e-i?d+Math.abs(e-i).toFixed(c).replace(/-/,0).slice(2):"";var e=n+a+s,l=t?this.currency.sign:this.currency.sign_html;return this.currency.sign_position?e+this.currency.sign_delim+l:l+this.currency.sign_delim+e},Product.prototype.serviceVariantHtml=function(e,t,i){return $('<option data-price="'+i+'" value="'+e+'"></option>').text(t+" (+"+this.currencyFormat(i,1)+")")},Product.prototype.updateSkuServices=function(e){this.form.find("div.stocks div").hide(),this.form.find(".sku-"+e+"-stock").show();for(var t in this.services[e]){var i=this.services[e][t];if(i===!1)this.form.find(".service-"+t).hide().find("input,select").attr("disabled","disabled").removeAttr("checked");else if(this.form.find(".service-"+t).show().find("input").removeAttr("disabled"),"string"==typeof i)this.form.find(".service-"+t+" .service-price").html(this.currencyFormat(i)),this.form.find(".service-"+t+" input").data("price",i);else{var r=this.form.find(".service-"+t+" .service-variants"),a=r.val();for(var s in i){var n=r.find("option[value="+s+"]");i[s]===!1?(n.hide(),n.attr("value")==a&&(a=!1)):(a||(a=s),n.replaceWith(this.serviceVariantHtml(s,i[s][0],i[s][1])))}this.form.find(".service-"+t+" .service-variants").val(a)}}},Product.prototype.updatePrice=function(e,t){if(void 0===e){var i=this.form.find(".skus input:radio:checked");if(i.length)var e=parseFloat(i.data("price")),t=parseFloat(i.data("compare-price"));else var e=parseFloat(this.add2cart.find(".price-new").data("price"))}t?(this.add2cart.find(".price-old").length||this.add2cart.find(".price-new").before('<span class="price-old"></span>'),this.add2cart.find(".price-old").html(this.currencyFormat(t)).show()):this.add2cart.find(".price-old").hide();var r=this;this.form.find(".services input:checked").each(function(){var t=$(this).val();e+=r.form.find(".service-"+t+"  .service-variants").length?parseFloat(r.form.find(".service-"+t+"  .service-variants :selected").data("price")):parseFloat($(this).data("price"))}),this.add2cart.find(".price-new").html(this.currencyFormat(e))},$(function(){if("undefined"==typeof product_reviews_display_mode||"product_page"!=product_reviews_display_mode)return!1;var e=$('<div><i class="icon16 loading"></i></div>');$("#review").append(e).load(product_url+"reviews/ .reviews",{random:"1"},function(){function e(){$.post(location.href.replace(/\/#\/[^#]*|\/#|\/$/g,"")+"/reviews/add/",c.serialize(),function(e){if("fail"==e.status)return i(c,!1),void t(c,e.errors);if("ok"!=e.status||!e.data.html)return void(console&&console.error("Error occured."));var r=e.data.html,a=parseInt(e.data.parent_id,10)||0,s=a?c.parents("li:first"):d,o=$("ul.reviews-branch:first",s);a?o.show().append(r):o.show().prepend(r),$(".reviews-count-text").text(e.data.review_count_str),$(".reviews-count").text(e.data.count),c.find("input[name=count]").val(e.data.count),i(c,!0),d.find(".write-review a").click(),n.hide(),"function"==typeof success&&success(e)},"json").error(function(e){console&&console.error(e.responseText?"Error occured: "+e.responseText:"Error occured.")})}function t(e,t){for(var i in t)$("[name="+i+"]",e).after($('<em class="errormsg"></em>').text(t[i])).addClass("error")}function i(e,t){t="undefined"==typeof t?!0:t,$(".errormsg",e).remove(),$(".error",e).removeClass("error"),$(".wa-captcha-refresh",e).click(),t&&($("input[name=captcha], textarea",e).val(""),$("input[name=rate]",e).val(0),$("input[name=title]",e).val(""),$(".rate",e).trigger("clear"))}function r(e){var t=this;e?(t.parents(".actions:first").after(n),$(".rate ",c).trigger("clear").parents(".review-field:first").hide()):(t.parents(".write-review").after(n),c.find(".rate").parents(".review-field:first").show()),i(c,!1),$("input[name=parent_id]",c).val(e),n.show()}function a(e,t,i){var r=s[t];c.off("keydown",e).on("keydown",e,function(e){return e.keyCode==r.key&&e.altKey==r.alt&&e.ctrlKey==r.ctrl&&e.shiftKey==r.shift?i():void 0})}initFormControl($("#review")),$("div.wa-captcha .wa-captcha-refresh, div.wa-captcha .wa-captcha-img").unbind("click").click(function(){var e=$(this).parents("div.wa-captcha"),t=e.find(".wa-captcha-img");return t.length&&(t.attr("src",t.attr("src").replace(/\?.*$/,"?rid="+Math.random())),t.one("load",function(){e.find(".wa-captcha-input").focus()})),e.find("input").val(""),!1});var s={"alt+enter":{ctrl:!1,alt:!0,shift:!1,key:13},"ctrl+enter":{ctrl:!0,alt:!1,shift:!1,key:13},"ctrl+s":{ctrl:!0,alt:!1,shift:!1,key:17}},n=$("#product-reivew-form"),c=n.find("form"),d=$(".reviews"),o=c.find("input[name=rate]");o.length||(o=$('<input name="rate" type="hidden" value=0>').appendTo(c)),$("#review-rate").rateWidget({onUpdate:function(e){o.val(e)}}),d.off("click",".review-reply, .write-review a").on("click",".review-reply, .write-review a",function(){var e=$(this),t=e.parents("li:first"),i=parseInt(t.attr("data-id"),10)||0;return r.call(e,i),!1});var l=$(".wa-captcha"),f=$("#user-auth-provider li"),h=f.filter(".selected").attr("data-provider");"guest"!=h&&h?l.hide():l.show(),f.find("a").click(function(){var e=$(this),t=e.parents("li:first");if(t.hasClass("selected"))return!1;t.siblings(".selected").removeClass("selected"),t.addClass("selected");var i=t.attr("data-provider");if(c.find("input[name=auth_provider]").val(i),"guest"==i)return $("div.provider-fields").hide(),$("div.provider-fields[data-provider=guest]").show(),l.show(),!1;if(i==h)return $("div.provider-fields").hide(),$("div.provider-fields[data-provider="+i+"]").show(),l.hide(),!1;var r=(screen.width-600)/2,a=(screen.height-400)/2;return window.open($(this).attr("href"),"oauth","width=600,height=400,left="+r+",top="+a+",status=no,toolbar=no,menubar=no"),!1}),a("textarea","ctrl+enter",e),c.submit(function(){return e(),!1})})});