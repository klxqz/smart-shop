function Product(t,e){this.form=$(t),this.add2cart=this.form.find(".add2cart"),this.button=this.add2cart.find("#button-cart");for(var i in e)this[i]=e[i];var r=this;this.form.find(".services input[type=checkbox]").click(function(){var t=$('select[name="service_variant['+$(this).val()+']"]');t.length&&($(this).is(":checked")?t.removeAttr("disabled"):t.attr("disabled","disabled")),r.updatePrice()}),this.form.find(".services .service-variants").on("change",function(){r.updatePrice()}),this.form.find(".skus input[type=radio]").click(function(){$(this).data("image-id")&&$("#product-image-"+$(this).data("image-id")).click(),$(this).data("disabled")?r.button.attr("disabled","disabled"):r.button.removeAttr("disabled");var t=$(this).val();r.updateSkuServices(t),r.updatePrice()});var a=this.form.find(".skus input[type=radio]:checked:not(:disabled)");a.length||(a=this.form.find(".skus input[type=radio]:not(:disabled):first").prop("checked",!0).click()),a.click(),this.form.find(".inline-select a").click(function(){var t=$(this).closest(".inline-select");return t.find("a.selected").removeClass("selected"),$(this).addClass("selected"),t.find(".sku-feature").val($(this).data("value")).change(),!1}),this.form.find(".sku-feature").change(function(){var t="";r.form.find(".sku-feature").each(function(){t+=$(this).data("feature-id")+":"+$(this).val()+";"});var e=r.features[t];e?(e.image_id&&$("#product-image-"+e.image_id).click(),r.updateSkuServices(e.id),e.available?r.button.removeAttr("disabled"):(r.form.find("div.stocks div").hide(),r.form.find(".sku-no-stock").show(),r.button.attr("disabled","disabled")),r.add2cart.find("price-new").data("price",e.price),r.updatePrice(e.price,e.compare_price)):(r.form.find("div.stocks div").hide(),r.form.find(".sku-no-stock").show(),r.button.attr("disabled","disabled"),r.add2cart.find(".price-old").hide(),r.add2cart.find(".price-new").empty())}),this.form.find(".sku-feature:first").change(),this.form.find(".skus input:radio:checked").length||this.form.find(".skus input:radio:enabled:first").attr("checked","checked"),this.form.submit(function(){var t=$(this),e=$('<div class="button-overlay"><i class="icon16 loading"></i></div>');return $(this).find("#button-cart").append(e),$.post(t.attr("action")+"?html=1",t.serialize(),function(i){if("ok"==i.status){var r=$("#cart-total"),a=t;e.remove();var s=$('<div class="product-info"></div>').append(t.clone());a.closest(".dialog").length?s.insertAfter(a.closest(".dialog")):s.appendTo("body"),s.css({top:a.offset().top,left:a.offset().left,width:a.width()+"px",height:a.height()+"px",position:"absolute",overflow:"hidden"}).animate({top:r.offset().top,left:r.offset().left,width:0,height:0,opacity:.5},500,function(){s.remove(),r.html(i.data.total);var t=$("#cart .cart-items tr[data-id="+i.data.item_id+"]"),e=parseInt(a.find("#input-quantity").val());if(t.length)e=parseInt(t.find(".quantity").text())+e,t.find(".quantity").text(e);else{var n=s.find(".ajax_product_info"),c={url:n.data("url"),name:n.data("name"),img:n.data("img"),price:n.data("price"),quantity:e,id:i.data.item_id};$("#cart_item_tmpl").tmpl(c).appendTo("#cart .cart-items table tbody"),$("#cart .cart-items").show(),$("#cart .cart-buttons").show(),$("#cart .cart-empty").hide()}}),a.closest(".dialog").length&&a.closest(".dialog").trigger("close"),i.data.error&&alert(i.data.error)}else"fail"==i.status&&alert(i.errors)},"json"),!1})}Product.prototype.currencyFormat=function(t,e){var i,r,a,s,n,c=this.currency.frac_digits,d=this.currency.decimal_point,o=this.currency.thousands_sep;isNaN(c=Math.abs(c))&&(c=2),void 0==d&&(d=","),void 0==o&&(o="."),i=parseInt(t=(+t||0).toFixed(c))+"",(r=i.length)>3?r%=3:r=0,n=r?i.substr(0,r)+o:"",a=i.substr(r).replace(/(\d{3})(?=\d)/g,"$1"+o),s=c&&t-i?d+Math.abs(t-i).toFixed(c).replace(/-/,0).slice(2):"";var t=n+a+s,l=e?this.currency.sign:this.currency.sign_html;return this.currency.sign_position?t+this.currency.sign_delim+l:l+this.currency.sign_delim+t},Product.prototype.serviceVariantHtml=function(t,e,i){return $('<option data-price="'+i+'" value="'+t+'"></option>').text(e+" (+"+this.currencyFormat(i,1)+")")},Product.prototype.updateSkuServices=function(t){this.form.find("div.stocks div").hide(),this.form.find(".sku-"+t+"-stock").show();for(var e in this.services[t]){var i=this.services[t][e];if(i===!1)this.form.find(".service-"+e).hide().find("input,select").attr("disabled","disabled").removeAttr("checked");else if(this.form.find(".service-"+e).show().find("input").removeAttr("disabled"),"string"==typeof i)this.form.find(".service-"+e+" .service-price").html(this.currencyFormat(i)),this.form.find(".service-"+e+" input").data("price",i);else{var r=this.form.find(".service-"+e+" .service-variants"),a=r.val();for(var s in i){var n=r.find("option[value="+s+"]");i[s]===!1?(n.hide(),n.attr("value")==a&&(a=!1)):(a||(a=s),n.replaceWith(this.serviceVariantHtml(s,i[s][0],i[s][1])))}this.form.find(".service-"+e+" .service-variants").val(a)}}},Product.prototype.updatePrice=function(t,e){if(void 0===t){var i=this.form.find(".skus input:radio:checked");if(i.length)var t=parseFloat(i.data("price")),e=parseFloat(i.data("compare-price"));else var t=parseFloat(this.add2cart.find(".price-new").data("price"))}e?(this.add2cart.find(".price-old").length||this.add2cart.find(".price-new").before('<span class="price-old"></span>'),this.add2cart.find(".price-old").html(this.currencyFormat(e)).show()):this.add2cart.find(".price-old").hide();var r=this;this.form.find(".services input:checked").each(function(){var e=$(this).val();t+=r.form.find(".service-"+e+"  .service-variants").length?parseFloat(r.form.find(".service-"+e+"  .service-variants :selected").data("price")):parseFloat($(this).data("price"))}),this.add2cart.find(".price-new").html(this.currencyFormat(t))},$(function(){$(".cart .compare-add").click(function(){var t=$.cookie("shop_compare");t=t?t.split(","):[];var e=$.inArray($(this).data("id")+"",t);-1==e&&t.push($(this).data("id"));var i=compare_url.replace(/compare\/.*$/,"compare/"+t.join(",")+"/");$(".compare-total").attr("href",i),$(".compare-total .count").text(t.length);var r=$(this).closest("#cart-form").find(".ajax_product_info");return showMsg('<i class="fa fa-check-circle"></i> Товар <a href="'+r.data("url")+'">'+r.data("name")+'</a> успешно добавлен в <a href="'+i+'">Список сравнения</a>'),t.length>0?$.cookie("shop_compare",t.join(","),{expires:30,path:"/"}):$.cookie("shop_compare",null,{expires:30,path:"/"}),!1}),$(".cart .wishlist-add").click(function(){var t=$.cookie("shop_wishlist");t=t?t.split(","):[];var e=$.inArray($(this).data("id")+"",t);-1==e&&t.push($(this).data("id")),$(".wishlist-total .count").text(t.length);var i=$(this).closest("#cart-form").find(".ajax_product_info");return showMsg('<i class="fa fa-check-circle"></i> Товар <a href="'+i.data("url")+'">'+i.data("name")+'</a> успешно добавлен в <a href="'+wishlist_url+'">Избранное</a>'),t.length>0?$.cookie("shop_wishlist",t.join(","),{expires:30,path:"/"}):$.cookie("shop_wishlist",null,{expires:30,path:"/"}),!1})}),$(function(){if("undefined"==typeof product_reviews_display_mode||"product_page"!=product_reviews_display_mode)return!1;var t=$('<div><i class="icon16 loading"></i></div>');$("#review").append(t).load(product_url+"reviews/ .reviews",{random:"1"},function(){function t(){$.post(location.href.replace(/\/#\/[^#]*|\/#|\/$/g,"")+"/reviews/add/",c.serialize(),function(t){if("fail"==t.status)return i(c,!1),void e(c,t.errors);if("ok"!=t.status||!t.data.html)return void(console&&console.error("Error occured."));var r=t.data.html,a=parseInt(t.data.parent_id,10)||0,s=a?c.parents("li:first"):d,o=$("ul.reviews-branch:first",s);a?o.show().append(r):o.show().prepend(r),$(".reviews-count-text").text(t.data.review_count_str),$(".reviews-count").text(t.data.count),c.find("input[name=count]").val(t.data.count),i(c,!0),d.find(".write-review a").click(),n.hide(),"function"==typeof success&&success(t)},"json").error(function(t){console&&console.error(t.responseText?"Error occured: "+t.responseText:"Error occured.")})}function e(t,e){for(var i in e)$("[name="+i+"]",t).after($('<em class="errormsg"></em>').text(e[i])).addClass("error")}function i(t,e){e="undefined"==typeof e?!0:e,$(".errormsg",t).remove(),$(".error",t).removeClass("error"),$(".wa-captcha-refresh",t).click(),e&&($("input[name=captcha], textarea",t).val(""),$("input[name=rate]",t).val(0),$("input[name=title]",t).val(""),$(".rate",t).trigger("clear"))}function r(t){var e=this;t?(e.parents(".actions:first").after(n),$(".rate ",c).trigger("clear").parents(".review-field:first").hide()):(e.parents(".write-review").after(n),c.find(".rate").parents(".review-field:first").show()),i(c,!1),$("input[name=parent_id]",c).val(t),n.show()}function a(t,e,i){var r=s[e];c.off("keydown",t).on("keydown",t,function(t){return t.keyCode==r.key&&t.altKey==r.alt&&t.ctrlKey==r.ctrl&&t.shiftKey==r.shift?i():void 0})}initFormControl($("#review")),$("div.wa-captcha .wa-captcha-refresh, div.wa-captcha .wa-captcha-img").unbind("click").click(function(){var t=$(this).parents("div.wa-captcha"),e=t.find(".wa-captcha-img");return e.length&&(e.attr("src",e.attr("src").replace(/\?.*$/,"?rid="+Math.random())),e.one("load",function(){t.find(".wa-captcha-input").focus()})),t.find("input").val(""),!1});var s={"alt+enter":{ctrl:!1,alt:!0,shift:!1,key:13},"ctrl+enter":{ctrl:!0,alt:!1,shift:!1,key:13},"ctrl+s":{ctrl:!0,alt:!1,shift:!1,key:17}},n=$("#product-reivew-form"),c=n.find("form"),d=$(".reviews"),o=c.find("input[name=rate]");o.length||(o=$('<input name="rate" type="hidden" value=0>').appendTo(c)),$("#review-rate").rateWidget({onUpdate:function(t){o.val(t)}}),d.off("click",".review-reply, .write-review a").on("click",".review-reply, .write-review a",function(){var t=$(this),e=t.parents("li:first"),i=parseInt(e.attr("data-id"),10)||0;return r.call(t,i),!1});var l=$(".wa-captcha"),f=$("#user-auth-provider li"),h=f.filter(".selected").attr("data-provider");"guest"!=h&&h?l.hide():l.show(),f.find("a").click(function(){var t=$(this),e=t.parents("li:first");if(e.hasClass("selected"))return!1;e.siblings(".selected").removeClass("selected"),e.addClass("selected");var i=e.attr("data-provider");if(c.find("input[name=auth_provider]").val(i),"guest"==i)return $("div.provider-fields").hide(),$("div.provider-fields[data-provider=guest]").show(),l.show(),!1;if(i==h)return $("div.provider-fields").hide(),$("div.provider-fields[data-provider="+i+"]").show(),l.hide(),!1;var r=(screen.width-600)/2,a=(screen.height-400)/2;return window.open($(this).attr("href"),"oauth","width=600,height=400,left="+r+",top="+a+",status=no,toolbar=no,menubar=no"),!1}),a("textarea","ctrl+enter",t),c.submit(function(){return t(),!1})})});