$(function(){function e(){$.post(location.href.replace(/\/#\/[^#]*|\/#|\/$/g,"")+"/add/",s.serialize(),function(e){if("fail"==e.status)return t(s,!1),void r(s,e.errors);if("ok"!=e.status||!e.data.html)return void(console&&console.error("Error occured."));var i=e.data.html,a=parseInt(e.data.parent_id,10)||0,n=a?s.parents("li:first"):d,c=$("ul.reviews-branch:first",n);a?c.show().append(i):c.show().prepend(i),$(".reviews-count-text").text(e.data.review_count_str),$(".reviews-count").text(e.data.count),s.find("input[name=count]").val(e.data.count),t(s,!0),d.find(".write-review a").click(),o.hide(),"function"==typeof success&&success(e)},"json").error(function(e){console&&console.error(e.responseText?"Error occured: "+e.responseText:"Error occured.")})}function r(e,r){for(var t in r)$("[name="+t+"]",e).after($('<em class="errormsg"></em>').text(r[t])).addClass("error")}function t(e,r){r="undefined"==typeof r?!0:r,$(".errormsg",e).remove(),$(".error",e).removeClass("error"),$(".wa-captcha-refresh",e).click(),r&&($("input[name=captcha], textarea",e).val(""),$("input[name=rate]",e).val(0),$("input[name=title]",e).val(""),$(".rate",e).trigger("clear"))}function i(e){var r=this;e?(r.parents(".actions:first").after(o),$(".rate ",s).trigger("clear").parents(".review-field:first").hide()):(r.parents(".write-review").after(o),s.find(".rate").parents(".review-field:first").show()),t(s,!1),$("input[name=parent_id]",s).val(e),o.show()}function a(e,r,t){var i=n[r];s.off("keydown",e).on("keydown",e,function(e){return e.keyCode==i.key&&e.altKey==i.alt&&e.ctrlKey==i.ctrl&&e.shiftKey==i.shift?t():void 0})}var n={"alt+enter":{ctrl:!1,alt:!0,shift:!1,key:13},"ctrl+enter":{ctrl:!0,alt:!1,shift:!1,key:13},"ctrl+s":{ctrl:!0,alt:!1,shift:!1,key:17}},o=$("#product-reivew-form"),s=o.find("form"),d=$(".content .reviews"),c=s.find("input[name=rate]");c.length||(c=$('<input name="rate" type="hidden" value=0>').appendTo(s)),$("#review-rate").rateWidget({onUpdate:function(e){c.val(e)}}),d.off("click",".review-reply, .write-review a").on("click",".review-reply, .write-review a",function(){var e=$(this),r=e.parents("li:first"),t=parseInt(r.attr("data-id"),10)||0;return i.call(e,t),!1});var l=$(".wa-captcha"),f=$("#user-auth-provider li"),u=f.filter(".selected").attr("data-provider");"guest"!=u&&u?l.hide():l.show(),f.find("a").click(function(){var e=$(this),r=e.parents("li:first");if(r.hasClass("selected"))return!1;r.siblings(".selected").removeClass("selected"),r.addClass("selected");var t=r.attr("data-provider");if(s.find("input[name=auth_provider]").val(t),"guest"==t)return $("div.provider-fields").hide(),$("div.provider-fields[data-provider=guest]").show(),l.show(),!1;if(t==u)return $("div.provider-fields").hide(),$("div.provider-fields[data-provider="+t+"]").show(),l.hide(),!1;var i=(screen.width-600)/2,a=(screen.height-400)/2;return window.open($(this).attr("href"),"oauth","width=600,height=400,left="+i+",top="+a+",status=no,toolbar=no,menubar=no"),!1}),a("textarea","ctrl+enter",e),s.submit(function(){return e(),!1})});